(function(){function x(){$("title").innerText="Game Menu";hide([$("game-view"),$("main-menu-btn")]);hide(this);show($("menu-view"));for(var a=document.querySelectorAll(".low-health"),b=0;b<a.length;b++)a[b].classList.remove("low-health");a=$$(".buffs");for(b=0;b<a.length;b++)a[b].innerHTML="";$("p1-turn-results").innerHTML="";$("p2-turn-results").innerHTML="";hide($("turn-status-p"));m&&(clearInterval(m),m=null)}function G(){$("your-pokedex-btn").onclick=function(){p(this.id,"your-pokedex-view");
h("my-dex-view",pid)};$$("#your-pokedex-view-card .name").ondblclick=H}function H(){if(k){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty();var a=y(k),b="Would you like to give "+k+" a nickname?";a&&(b='Would you like to rename your "'+a+'"?');if(confirm(b)&&(a=prompt("Nickname to give your "+k+" (Leave empty to remove nickname):",a?a:""),null!==a)){var b="Calling update.php with name="+k,c=new FormData;c.append("name",k);""!=a?(c.append("nickname",
a),b+=" and nickname="+a):b+=" and no nickname";console.log(b);postRequest("update.php",c,function(){alert("Success! You have renamed "+(""!=a?a:k)+"!");h("pokedex-view",pid);h("my-pokemon",pid);h("my-dex-view",pid);var b=k+(""!=a?" ("+a+")":"");$$("#your-pokedex-view-card .name").innerText=b})}}}function I(){J();$("new-game-btn").onclick=function(){p(this.id,"new-game-view");$("new-game-view").classList.contains("hidden")||$$("#new-game-view .part-0").classList.remove("hidden")};$("choose-pokemon-btn").onclick=
function(){h("pokedex-view",pid);toggleDisplay($$("#new-game-view .part-iii"));this.classList.toggle("chosen-btn")};$("start-game").onclick=function(){""!=k&&(""==n&&(n="-bot-"),$("choose-pokemon-title").innerText="Choose a Pokemon:",show($$("#new-game-view .part-iii hr")),K(n))}}function J(){for(var a=$$(".opponent-btn"),b=0;b<a.length;b++)a[b].onclick=function(){hide([$$("#new-game-view .part-ii"),$$("#new-game-view .part-iii")]);this.classList.toggle("chosen-btn");for(var b=$$("#new-game-view button"),
d=0;d<b.length;d++)b[d]!=this&&b[d].classList.remove("chosen-btn");for(b=0;b<a.length;b++)if(a[b]!=this)if(this.classList.contains("chosen-btn"))a[b].classList.remove("chosen-btn"),"student"!=this.id&&hide($("choose-student")),show($$("#new-game-view .part-ii"));else{hide([$$("#new-game-view .part-ii")]);hide([$$("#new-game-view .part-iii")]);for(var d=$$("#new-game-view button"),e=0;e<d.length;e++)d[e].classList.remove("chosen-btn");show(a[b])}"student"==this.id?(toggleDisplay($("choose-student")),
$("choose-student").classList.contains("hidden")||(n="medskm")):n=this.id}}function L(){$("trade-btn").onclick=function(){p(this.id,"trade-view");hide($("current-proposals-view"));hide($("new-proposal-view"))};$("propose").onclick=function(){this.classList.toggle("chosen-btn");this.classList.contains("chosen-btn")&&$("view-proposals").classList.remove("chosen-btn");hide($("current-proposals-view"));toggleDisplay($("new-proposal-view"));$("new-proposal-view").classList.contains("hidden")&&(show($("show-p2-dex")),
hide($("pokedices")))};$("propose-submit").onclick=M;$("view-proposals").onclick=function(){toggleDisplay($("current-proposals-view"));this.classList.toggle("chosen-btn");hide($("new-proposal-view"));this.classList.contains("chosen-btn")&&($("propose").classList.remove("chosen-btn"),t())};$("show-p2-dex").onclick=function(){show([$$("#new-proposal-view .part-iv"),$("pokedices")]);this.classList.add("hidden");h("my-pokemon",pid);h("their-pokemon",$("users").value)};$("users").onchange=function(){h("my-pokemon",
pid);h("their-pokemon",$("users").value)}}function N(){$("invite-btn").onclick=function(){z()}}function O(){var a={37:"left",38:"up",39:"right",40:"down",65:"a",66:"b"},b="up up down down left right left right b a".split(" "),c=0;document.addEventListener("keydown",function(d){a[d.keyCode]==b[c]?(c++,c==b.length&&(P(),c=0)):c=0})}function P(){alert("Welcome PonyTA.");(function(a,b){var c=1,d=function(){--c;0===c&&(BrowserPonies.setBaseUrl(b.baseurl),BrowserPoniesBaseConfig.loaded||(BrowserPonies.loadConfig(BrowserPoniesBaseConfig),
BrowserPoniesBaseConfig.loaded=!0),BrowserPonies.loadConfig(b),BrowserPonies.running()||BrowserPonies.start())};"undefined"===typeof BrowserPoniesConfig&&(window.BrowserPoniesConfig={});"undefined"===typeof BrowserPoniesBaseConfig&&(++c,BrowserPoniesConfig.onbasecfg=d);"undefined"===typeof BrowserPonies&&(++c,BrowserPoniesConfig.oninit=d);var e=document.body||document.documentElement||document.getElementsByTagName("head")[0],g;for(g in a)if(!document.getElementById(g))if(e){var f=document.createElement("script");
f.type="text/javascript";f.id=g;f.src=a[g];e.appendChild(f)}else document.write('<script type="text/javscript" src="'+a[g]+'" id="'+g+'">\x3c/script>');d()})({"browser-ponies-script":"https://panzi.github.io/Browser-Ponies/browserponies.js","browser-ponies-config":"https://panzi.github.io/Browser-Ponies/basecfg.js"},{baseurl:"https://panzi.github.io/Browser-Ponies/",fadeDuration:500,volume:1,fps:25,speed:3,audioEnabled:!1,dontSpeak:!0,showFps:!1,showLoadProgress:!0,speakProbability:.1,spawn:{"rainbow dash":1}});
void 0;document.body.style.background="-webkit-linear-gradient(top, #2d96c6 0%,#c9e6f4 100%)";document.body.style.height="100vh";$("title").innerText="PonyTA MODE ACTIVE!"}function z(){getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/list-games.php",creds(),Q)}function h(a,b){var c=b==pid;getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/users.php","?mode=pokemon&pid="+b,function(b){b=JSON.parse(b);for(var d=$(a),g=$(a).querySelectorAll(".sprite"),f=0;f<g.length;f++)g[f].classList.add("unfound"),
g[f].onclick="";for(g=0;g<b.length;g++)if(f=d.querySelector("img[pokemon='"+escSpChar(b[g])+"']"))f.classList.remove("unfound"),f.onclick="pokedex-view"==a?A:R;c&&fetchMyPokemon()})}function t(){getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/list-trades.php",creds(),S)}function B(a,b){getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/trade-info.php",creds()+"&trade_id="+a,function(a){var c=JSON.parse(a);a=gen("tr");a.id=c.id;var e=genText("td","to-you"===b?c.offerer:c.offeree),
g=gen("td"),f=genText("p",c.requested_pokemon),h=genText("p",c.offered_pokemon),l=$$("#pokedex-view .sprite[pokemon='"+c.requested_pokemon+"']").cloneNode();g.appendChild(f);f.appendChild(l);var f=gen("td"),k=$$("#pokedex-view .sprite[pokemon='"+c.offered_pokemon+"']").cloneNode();"to-you"===b?l.classList.remove("unfound"):k.classList.remove("unfound");f.appendChild(h);h.appendChild(k);h=genText("td",c.created);c=gen("td");appendChildren(a,[e,f,g,h]);"to-you"==b?(e=gen("button","small-btn"),e.innerText=
"Accept",e.onclick=T,g=gen("button","small-btn"),g.innerText="Reject",g.onclick=C,appendChildren(c,[e,g])):(e=gen("button","small-btn"),e.innerText="Cancel Request",c.appendChild(e),e.onclick=C);a.appendChild(c);$$("#"+b+" .results-table tbody").appendChild(a)})}function S(a){a=JSON.parse(a);if(0===a.offers_from_me.length&&0===a.offers_to_me.length)$("trade-message").innerHTML="There are no trades currently offered to you.",hide([$("by-you"),$("to-you")]),show($("trade-message"));else{var b=a.offers_to_me;
0<b.length?$$("#to-you .results-table").innerHTML="<tr><th>Player</th><th>Their Offer</th><th>Their Request</th><th>Date</th></tr>":$$("#to-you .results-table").innerHTML="<p>You do not have any proposals to accept or decline.</p>";for(var c=0;c<b.length;c++)B(b[c],"to-you");a=a.offers_from_me;0<a.length?$$("#by-you .results-table").innerHTML="<tr><th>Player</th><th>Your Offer</th><th>Your Request</th><th>Date</th></tr>":$$("#by-you .results-table").innerHTML="<p>You do not have any proposals waiting to be accepted or declined by other players.</p>";
for(b=0;b<a.length;b++)B(a[b],"by-you");hide($("trade-message"));show([$("by-you"),$("to-you"),$$("#by-you .results-table"),$$("#to-you .results-table")])}}function U(a){a=JSON.parse(a);for(var b=$("users"),c=0;c<a.length;c++)if(a[c]!=pid){var d=document.createElement("option");d.value=a[c];d.innerText=a[c];b.appendChild(d);d=document.createElement("option");d.value=a[c];d.innerText=a[c];$("opps").appendChild(d)}$("opps").value="whitab";$("users").value="whitab";$("opps").onchange=function(){n=this.value;
show($("choose-pokemon-btn"));show($("start-game"))}}function T(){if(confirm("Are you sure you want to accept this trade?")){var a=this.parentNode.parentNode.id,b=new FormData;b.append("pid",pid);b.append("token",token);b.append("action","accept");var c=this.parentNode.parentNode.querySelectorAll("td")[2].innerText.trim(),d=this.parentNode.parentNode.querySelectorAll("td")[1].innerText.trim();b.append("pokemon",c);b.append("trade_id",a);postRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/conclude-trade.php",
b,function(){alert("Trade successful!");console.log("Calling student's trade.php with mypokemon="+c+" and theirpokemon="+d+"...");var a=new FormData;a.append("mypokemon",c);a.append("theirpokemon",d);postRequest("trade.php",a,logStudentTestCall);a="";confirm("You've collected "+d+" from a trade! Give it a nickname?")&&(a=prompt("Nickname to give your "+d+":"));if(a){var b=new FormData;b.append("name",d);b.append("nickname",a);console.log("Calling student's update.php with name="+name+" and nickname="+
a+"...");postRequest("update.php",b,logStudentTestCall)}t()})}}function C(){if(confirm("Are you sure you want to cancel this trade?")){var a=this.parentNode.parentNode.id,b=new FormData;b.append("pid",pid);b.append("token",token);b.append("pokemon",this.parentNode.parentNode.querySelectorAll("td")[2].innerText.trim());b.append("tradeid",a);postRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/cancel-trade.php",b,function(){alert("Trade successfully canceled");t()})}}function M(){var a=$("offer").innerText,
b=$("request").innerText;if(""!=a&&""!=b){var c=new FormData;c.append("pid",pid);c.append("pid2",$("users").value);c.append("token",token);c.append("pokemon",a);c.append("pokemon2",b);postRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/offer-trade.php",c,function(){alert("Proposal successful!");$("view-proposals").click()})}else alert("Please select a Pokemon to offer and request from the displayed Pokedex views.")}function R(){this.parentNode.parentNode.querySelector("h2 span")?this.parentNode.parentNode.querySelector("h2 span").innerText=
this.getAttribute("pokemon"):(k=this.getAttribute("pokemon"),A.call(this))}function Q(a){a=JSON.parse(a);a.offered_by_me||a.offered_to_me||a.in_progress?($("games-table").innerHTML="<tr><th>Other Player</th></tr>",a.offered_by_me&&u("Pending","cancel",a.offered_by_me),a.offered_to_me&&u("Pending","accept",a.offered_to_me),a.in_progress&&u("current","join",a.in_progress)):$$("#invite-results h3").innerHTML="You currently have no games in progress or pending.";p("invite-btn","invite-view")}function V(a){a=
a.split("\n");for(var b=0;b<a.length;b++){var c=a[b].split(":"),d=c[0],c=c[1],e=gen("img",["sprite","unfound"]);e.src="https://courses.cs.washington.edu/courses/cse154/webservices/pokedex/sprites/"+c;e.setAttribute("pokemon",d);$("my-pokemon").appendChild(e);$("their-pokemon").appendChild(e.cloneNode());$("pokedex-view").appendChild(e.cloneNode());$("my-dex-view").appendChild(e.cloneNode())}}function u(a,b,c){for(a=0;a<c.length;a++){var d=c[a][0],e=c[a][1];e==pid&&(e=c[a][2]);e||(e="-bot-");var e=
genText("td",e),g=gen("td"),f=gen("button",["small-btn"]);"accept"==b?(f.innerText="Accept Invite",f.onclick=function(){n=this.parentNode.parentNode.querySelector("td").innerText;hide($("opponent-btns"));hide($("choose-student"));hide($$("#new-game-view .part-ii"));n&&"-bot-"!=n&&(hide($$("#new-game-view .part-iii hr")),$("choose-pokemon-title").innerText="Choose a Pokemon to play with "+n+":",h("pokedex-view",pid),show([$$("#new-game-view"),$$("#new-game-view .part-iii")]),hide($("invite-view")))},
g.appendChild(f)):"join"==b?(f.innerText="Continue Game",g.appendChild(f),f.onclick=function(){v(this.parentNode.parentNode.id)}):"cancel"==b&&(f=genText("span","Invite Pending"),g.appendChild(f));f=gen("tr");f.id=d;appendChildren(f,[e,g]);$("games-table").appendChild(f)}show($("games-table"))}function D(a){console.log(a);if(a.warning)console.log(a.warning);else{var b=a.pid1,c=a.pid2,b=b==pid?c:b,c=a.players[pid],d=a[c],e=a[a.players[b]];"-bot-"!=b&&(c==a.turn?($("turn-status").innerText="It's your turn!",
$("turn-status").classList.add("your-turn")):($("turn-status").innerText="Waiting for "+b+" to make a move...",$("turn-status").classList.remove("your-turn")),show($("turn-status-p")));q("my-card",d);q("their-card",e);r("my-card",d);r("their-card",e);w=a.guid;$("title").innerText="Pokemon Battle Mode!";a=$$(".opponent-btn");for(b=0;b<a.length;b++)a[b].classList.remove("chosen-btn"),a[b].classList.remove("hidden");a=$$(".menu-btn");for(b=0;b<a.length;b++)a[b].classList.remove("chosen-btn");E();hide([$("menu-view")]);
show([$("game-view"),$("main-menu-btn"),$("results-container")])}}function K(a){if(""==k)alert("Please select a Pokemon to start a game with.");else{var b=new FormData;b.append("opponent",a);b.append("mypokemon",k);b.append("pid",pid);b.append("token",token);postRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/create-game.php",b,function(b){"-bot-"==a||"invite-view"==document.querySelector(".current-view").id?(D(JSON.parse(b)),m||(m=setInterval(v,3E3,JSON.parse(b).guid))):(alert("Game invite sent successfully!"),
z())})}}function v(a){w=a;console.log("Updating current player game info.");getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/game-info.php",creds()+"&guid="+a,function(a){D(JSON.parse(a))});m||(m=setInterval(v,3E3,a))}function q(a,b){a="#"+a;$$(a+" .name").innerHTML=b.name;$$(a+" .pokepic").src="https://courses.cs.washington.edu/courses/cse154/webservices/pokedex/"+b.images.photo;$$(a+" .weakness").src="https://courses.cs.washington.edu/courses/cse154/webservices/pokedex/"+b.images.weaknessIcon;
$$(a+" .type").src="https://courses.cs.washington.edu/courses/cse154/webservices/pokedex/"+b.images.typeIcon;$$(a+" .info").innerHTML=b.info.description;$$(a+" .hp").innerHTML=b.hp+"HP";for(var c=b.moves,d=$$(a+" .moves button"),e=0;e<c.length;e++){var g=d[e];g.classList.contains("hidden")&&g.classList.remove("hidden");g.children[0].innerText=c[e].name;g.children[2].src="https://courses.cs.washington.edu/courses/cse154/webservices/pokedex/icons/"+c[e].type+".jpg";g.children[1].innerText=c[e].dp?c[e].dp+
" DP":"";"#my-card"===a&&(g.disabled=!1,g.onclick=function(){W(this.children[0].innerText)})}if("#chosen-card"===a||"#my-card"===a||"#your-pokedex-view-card"===a)if(c=b.name?y(b.name):"")$$(a+" h2.name").innerText=b.name+" ("+c+")";for(;4>e;)d[e].classList.add("hidden"),e++}function W(a){$("p1-turn-results").innerHTML="";$("p2-turn-results").innerHTML="";show($("loading"));a=a.toLowerCase();var b=new FormData;b.append("move",a);b.append("guid",w);b.append("pid",pid);b.append("token",token);var c=
new XMLHttpRequest;c.onreadystatechange=function(a){if(4===c.readyState)if(200===c.status){a=JSON.parse(this.responseText);var b=a.pid1,d=a.pid2,b=b==pid?d:b,f=a.players[pid],d=a[f],h=a[a.players[b]];"-bot-"!=b?(f==a.turn?($("turn-status").innerText="It's your turn!",$("turn-status").classList.add("your-turn")):($("turn-status").innerText="Waiting for "+b+" to make a move...",$("turn-status").classList.remove("your-turn")),show($("turn-status-p"))):b=h.name;r("my-card",d);r("their-card",h);var l=
a.results,d=l["p1-result"],k=l["p2-result"],f="p1"==f;""!=a.turn?(k&&(h=f?b:"You","p2"==a.turn?$("p1-turn-results").innerHTML=h+" played "+l["p2-move"]+" and "+k+"!":$("p2-turn-results").innerHTML=h+" played "+l["p2-move"]+" and "+k+"!"),d&&(b=f?"You":b,"p2"==a.turn?$("p2-turn-results").innerHTML=b+" played "+l["p1-move"]+" and "+d+"!":$("p1-turn-results").innerHTML=b+" played "+l["p1-move"]+" and "+d+"!")):0==h["current-hp"]?(a=f?l["p1-move"]:l["p2-move"],b=f?d:k,$("p1-turn-results").innerHTML="You played "+
a+" and "+b+"!"):(a=f?l["p2-move"]:l["p1-move"],d=f?k:d,$("p1-turn-results").innerHTML=b+" played "+a+" and "+d+"!");hide($("loading"));show([$("p1-turn-results"),$("p2-turn-results")])}else 201===c.status&&(a=JSON.parse(c.statusText).warning,console.log(a),$("turn-status").innerText="It's not your turn!",show($("turn-status-p")),hide($("loading")))};c.open("POST","https://oxford.cs.washington.edu/cse154/pokedex-2/move.php");c.send(b)}function A(){$("start-game").classList.contains("hidden")&&$("start-game").classList.remove("hidden");
var a=this.getAttribute("pokemon");""!=a&&(k=a,getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/pokedex.php","?pokemon="+a,function(a){a=JSON.parse(a);q("chosen-card",a);q("my-card",a);q("your-pokedex-view-card",a)}))}function r(a,b){if(!b.error){var c=$(a);c.querySelector(".hp").innerText=b["current-hp"]+"HP";c.querySelector(".buffs").innerHTML="";for(var d=$$("#"+a+" .buffs"),e=b.buffs,g=b.debuffs,f=0;f<e.length+g.length;f++){var h=f<e.length?e[f]:g[f],k=document.createElement("div");
k.className=f<e.length?"buff":"debuff";k.classList.add(h);d.appendChild(k)}d=1*b["current-hp"]/b.hp;c.querySelector(".health-bar").style.width=100*d+"%";"my-card"==a?0==d?F(!1):.2>=d&&c.querySelector(".health-bar").classList.add("low-health"):"their-card"==a&&(0==d?(F(!0),c=b.name,(d=$("my-pokemon").querySelector(".sprite[pokemon="+escSpChar(c)+"]"))&&d.classList.contains("unfound")&&X(c)):.2>=d&&c.querySelector(".health-bar").classList.add("low-health"))}hide($("loading"))}function F(a){var b=$("my-card").querySelectorAll(".moves button");
hide($("turn-status-p"));for(var c=0;c<b.length;c++)b[c].disabled=!0;$("title").innerHTML="You "+(a?"won!":"lost!");show([$("results-container"),$("endgame")]);m&&(clearInterval(m),m=null)}function X(a){var b="";confirm("You've collected "+a+"! Give it a nickname?")&&(b=prompt("Nickname to give your "+a+":"));var c="Calling insert.php with name="+a,d=new FormData;d.append("name",a);""!=b?(d.append("nickname",b),c+=" and nickname="+b):c+=" and no nickname";console.log(c);postRequest("insert.php",d,
function(){alert("Success! You have added "+(""!=b?b:a)+" to your Pokedex!");h("pokedex-view",pid);h("my-pokemon",pid);h("my-dex-view",pid)})}function E(){var a=document.querySelector(".current-view");a&&a.classList.remove(".current-view");for(var a=document.querySelectorAll(".sub-menu"),b=0;b<a.length;b++)hide(a[b])}function p(a,b){hide($$("#new-game-view .part-iii"));if($(a).classList.contains("chosen-btn"))$(a).classList.remove("chosen-btn"),E();else{for(var c=document.querySelectorAll(".sub-menu"),
d=document.querySelectorAll(".chosen-btn"),e=0;e<d.length;e++)d[e]!=a&&d[e].classList.remove("chosen-btn");$(a).classList.add("chosen-btn");if($(b).classList.contains("hidden"))for(d=0;d<c.length;d++)c[d]!=$(b)?(hide(c[d]),c[d].classList.remove("current-view")):(show(c[d]),c[d].classList.add("current-view"),"trade-view"===b&&(hide($("new-proposal-view")),hide($("current-proposals-view"))))}}function y(a){a=a.toLowerCase();for(var b=myPokemon.pokemon,c=0;c<b.length;c++){var d=b[c].name.toLowerCase();
if(d==a&&d.toUpperCase()!=b[c].nickname)return b[c].nickname}return null}var k="",n="",w="",m=null;window.onload=function(){fetchPid();getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/pokedex.php","?pokedex=all",V);getRequest("https://oxford.cs.washington.edu/cse154/pokedex-2/list-users.php","",U);fetchMyPokemon();G();I();N();L();O();$("main-menu-btn").onclick=x;$("endgame").onclick=x;$("restart-btn").onclick=function(){confirm("Are you sure you want to remove all Pokemon from your Pokedex and start with three new random Pokemon?")&&
(getDex(pid,token,!0),setTimeout(function(){h("my-dex-view",pid)},1E3))};p("your-pokedex-btn","your-pokedex-view");var a=setInterval(function(){pid&&token&&myPokemon&&(clearInterval(a),h("my-dex-view",pid))},100)}})();
